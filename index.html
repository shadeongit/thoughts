<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            padding: 40px;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1000px;
            width: 95%;
            height: 90vh;
            display: flex;
            overflow: hidden;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        h2 {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            text-align: center;
        }

        .logo {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .link-btn {
            background: none;
            color: #667eea;
            text-align: center;
            margin-top: 15px;
            cursor: pointer;
            font-size: 14px;
        }

        .link-btn:hover {
            transform: none;
            box-shadow: none;
            text-decoration: underline;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: #fee;
            border-radius: 5px;
            display: none;
        }

        .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: #d4edda;
            border-radius: 5px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* Chat Interface */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .logout-icon {
            cursor: pointer;
            font-size: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .logout-icon:hover {
            background: rgba(255,255,255,0.2);
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-item:hover {
            background: #e8e8e8;
        }

        .user-item.active {
            background: #667eea;
            color: white;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .user-item.active .user-avatar {
            background: white;
            color: #667eea;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .last-message {
            font-size: 13px;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-item.active .last-message {
            color: rgba(255,255,255,0.8);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .chat-header h3 {
            margin: 0;
            color: #333;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            align-self: flex-start;
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .empty-chat-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .app-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .sidebar {
                width: 100%;
                display: none;
            }

            .sidebar.mobile-show {
                display: flex;
            }

            .chat-area.mobile-hide {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="container">
        <div class="logo">üí¨</div>
        <h1>Welcome Back!</h1>
        <h2>Login to your account</h2>
        
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="loginUsername" placeholder="Enter your username">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Enter your password">
        </div>
        
        <div id="loginError" class="error"></div>
        
        <button class="btn" onclick="login()">Login</button>
        <button class="btn link-btn" onclick="showRegister()">Don't have an account? Register</button>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="container hidden">
        <div class="logo">üí¨</div>
        <h1>Create Account</h1>
        <h2>Join our chat community</h2>
        
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="registerUsername" placeholder="Choose a username">
        </div>
        
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="registerPassword" placeholder="Choose a password">
        </div>
        
        <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" id="registerConfirmPassword" placeholder="Confirm your password">
        </div>
        
        <div id="registerError" class="error"></div>
        <div id="registerSuccess" class="success"></div>
        
        <button class="btn" onclick="register()">Register</button>
        <button class="btn link-btn" onclick="showLogin()">Already have an account? Login</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="container hidden" style="max-width: 1000px; padding: 40px;">
        <h1>üîê Admin Dashboard</h1>
        <h2>Manage all users and conversations</h2>
        
        <div style="margin: 30px 0;">
            <button class="btn" onclick="logout()" style="width: auto; padding: 12px 30px;">Logout</button>
        </div>

        <div id="adminContent"></div>
    </div>

    <!-- Chat App -->
    <div id="chatApp" class="app-container hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3 id="currentUsername">Chats</h3>
                <span class="logout-icon" onclick="logout()" title="Logout">üö™</span>
            </div>
            <div class="user-list" id="userList"></div>
        </div>

        <div class="chat-area">
            <div id="emptyChatState" class="empty-chat">
                <div class="empty-chat-icon">üí¨</div>
                <h3>Select a chat to start messaging</h3>
                <p>Choose a user from the sidebar</p>
            </div>

            <div id="activeChat" class="hidden" style="display: flex; flex-direction: column; flex: 1;">
                <div class="chat-header">
                    <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
                    <h3 id="chatHeaderName"></h3>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, query, orderByChild } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlpOqjYbQKcpZO5l3d0gRJbNPZdeKfsUg",
            authDomain: "didybl.firebaseapp.com",
            databaseURL: "https://didybl-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "didybl",
            storageBucket: "didybl.firebasestorage.app",
            messagingSenderId: "519998499974",
            appId: "1:519998499974:web:ade139e0e1662cd3633507",
            measurementId: "G-KWDHL7CM6L"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        let currentUser = null;
        let activeChat = null;
        let allUsers = {};

        // Show/Hide Pages
        function showPage(pageId) {
            document.querySelectorAll('.container, .app-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        window.showLogin = function() {
            showPage('loginPage');
            document.getElementById('loginError').style.display = 'none';
        }

        window.showRegister = function() {
            showPage('registerPage');
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('registerSuccess').style.display = 'none';
        }

        // Registration
        window.register = async function() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (!username || !password || !confirmPassword) {
                errorDiv.textContent = 'Please fill in all fields';
                errorDiv.style.display = 'block';
                return;
            }

            if (username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (password.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);

                if (snapshot.exists()) {
                    errorDiv.textContent = 'Username already exists';
                    errorDiv.style.display = 'block';
                    return;
                }

                await set(userRef, {
                    username: username,
                    password: password,
                    createdAt: Date.now()
                });

                successDiv.textContent = '‚úì Account created successfully! Please login.';
                successDiv.style.display = 'block';
                
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                document.getElementById('registerConfirmPassword').value = '';

                setTimeout(() => {
                    showLogin();
                }, 1500);

            } catch (error) {
                errorDiv.textContent = 'Registration failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        // Login
        window.login = async function() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.style.display = 'block';
                return;
            }

            // Check for admin account
            if (username === 'admin-1' && password === 'secure') {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                localStorage.setItem('isAdmin', 'true');
                loadAdminPanel();
                return;
            }

            try {
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);

                if (!snapshot.exists()) {
                    errorDiv.textContent = 'User not found';
                    errorDiv.style.display = 'block';
                    return;
                }

                const userData = snapshot.val();
                if (userData.password !== password) {
                    errorDiv.textContent = 'Incorrect password';
                    errorDiv.style.display = 'block';
                    return;
                }

                currentUser = username;
                localStorage.setItem('currentUser', username);
                localStorage.setItem('isAdmin', 'false');
                loadChatApp();

            } catch (error) {
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        // Load Chat App
        async function loadChatApp() {
            showPage('chatApp');
            document.getElementById('currentUsername').textContent = currentUser;

            // Load all users
            const usersRef = ref(database, 'users');
            onValue(usersRef, (snapshot) => {
                allUsers = snapshot.val() || {};
                displayUserList();
            });
        }

        function displayUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            for (let username in allUsers) {
                if (username === currentUser) continue;

                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.onclick = () => openChat(username);

                const avatar = username.charAt(0).toUpperCase();
                
                userItem.innerHTML = `
                    <div class="user-avatar">${avatar}</div>
                    <div class="user-info">
                        <div class="user-name">${username}</div>
                        <div class="last-message">Start a conversation...</div>
                    </div>
                `;

                userList.appendChild(userItem);
            }
        }

        window.openChat = function(username) {
            activeChat = username;

            // Update active state
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget?.classList.add('active');

            // Show chat area
            document.getElementById('emptyChatState').classList.add('hidden');
            document.getElementById('activeChat').classList.remove('hidden');

            // Update header
            const avatar = username.charAt(0).toUpperCase();
            document.getElementById('chatHeaderAvatar').textContent = avatar;
            document.getElementById('chatHeaderName').textContent = username;

            // Load messages
            loadMessages(username);
        }

        function loadMessages(otherUser) {
            const chatId = getChatId(currentUser, otherUser);
            const messagesRef = ref(database, `chats/${chatId}/messages`);

            onValue(messagesRef, (snapshot) => {
                const messages = snapshot.val();
                displayMessages(messages);
            });
        }

        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            if (!messages) return;

            Object.values(messages).forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender === currentUser ? 'message-sent' : 'message-received'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.innerHTML = `
                    <div>${msg.text}</div>
                    <div class="message-time">${time}</div>
                `;
                
                chatMessages.appendChild(messageDiv);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !activeChat) return;

            const chatId = getChatId(currentUser, activeChat);
            const messagesRef = ref(database, `chats/${chatId}/messages`);
            const newMessageRef = push(messagesRef);

            await set(newMessageRef, {
                text: text,
                sender: currentUser,
                timestamp: Date.now()
            });

            input.value = '';
            input.focus();
        }

        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }

        window.logout = function() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            currentUser = null;
            activeChat = null;
            showLogin();
        }

        // Admin Panel
        async function loadAdminPanel() {
            showPage('adminPanel');
            
            const usersRef = ref(database, 'users');
            const usersSnapshot = await get(usersRef);
            const users = usersSnapshot.val() || {};

            const chatsRef = ref(database, 'chats');
            const chatsSnapshot = await get(chatsRef);
            const chats = chatsSnapshot.val() || {};

            let html = '<div style="margin-bottom: 30px;">';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">';
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">${Object.keys(users).length}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Users</div>
                     </div>`;
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 36px; font-weight: 700;">${Object.keys(chats).length}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Active Chats</div>
                     </div>`;
            html += '</div></div>';

            html += '<h3 style="margin-top: 30px; margin-bottom: 20px; color: #333;">All Users</h3>';
            
            for (let username in users) {
                const user = users[username];
                const createdDate = new Date(user.createdAt).toLocaleDateString();
                
                html += `<div style="background: white; border: 2px solid #e0e0e0; border-radius: 15px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #333; margin-bottom: 5px;">üë§ ${username}</div>
                            <div style="font-size: 14px; color: #666;">Joined: ${createdDate}</div>
                        </div>
                        <button onclick="deleteUserAdmin('${username}')" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600;">Delete User</button>
                    </div>
                </div>`;
            }

            html += '<h3 style="margin-top: 40px; margin-bottom: 20px; color: #333;">All Conversations</h3>';
            
            if (Object.keys(chats).length === 0) {
                html += '<p style="text-align: center; color: #999; padding: 40px;">No conversations yet</p>';
            } else {
                for (let chatId in chats) {
                    const messages = chats[chatId].messages || {};
                    const messageCount = Object.keys(messages).length;
                    const users = chatId.split('_');
                    
                    html += `<div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 15px;">
                        <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 10px;">
                            üí¨ ${users[0]} ‚ÜîÔ∏è ${users[1]}
                        </div>
                        <div style="color: #666; margin-bottom: 10px;">${messageCount} messages</div>
                        <button onclick="viewConversation('${chatId}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">View</button>
                        <button onclick="deleteConversation('${chatId}')" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
                    </div>`;
                }
            }

            document.getElementById('adminContent').innerHTML = html;
        }

        window.deleteUserAdmin = async function(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This will also delete all their conversations.`)) {
                return;
            }

            try {
                // Delete user
                const userRef = ref(database, `users/${username}`);
                await set(userRef, null);

                // Delete all chats involving this user
                const chatsRef = ref(database, 'chats');
                const snapshot = await get(chatsRef);
                const chats = snapshot.val() || {};

                for (let chatId in chats) {
                    if (chatId.includes(username)) {
                        const chatRef = ref(database, `chats/${chatId}`);
                        await set(chatRef, null);
                    }
                }

                alert(`User "${username}" deleted successfully!`);
                loadAdminPanel();
            } catch (error) {
                alert('Error deleting user');
            }
        }

        window.deleteConversation = async function(chatId) {
            if (!confirm('Are you sure you want to delete this conversation?')) {
                return;
            }

            try {
                const chatRef = ref(database, `chats/${chatId}`);
                await set(chatRef, null);
                alert('Conversation deleted successfully!');
                loadAdminPanel();
            } catch (error) {
                alert('Error deleting conversation');
            }
        }

        window.viewConversation = async function(chatId) {
            const chatRef = ref(database, `chats/${chatId}/messages`);
            const snapshot = await get(chatRef);
            const messages = snapshot.val() || {};

            let modalHtml = `<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;" onclick="this.remove()">
                <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <h2 style="margin-bottom: 20px;">Conversation: ${chatId.replace('_', ' ‚ÜîÔ∏è ')}</h2>`;

            if (Object.keys(messages).length === 0) {
                modalHtml += '<p style="text-align: center; color: #999;">No messages</p>';
            } else {
                Object.values(messages).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    modalHtml += `<div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 5px;">${msg.sender}</div>
                        <div style="color: #333; margin-bottom: 5px;">${msg.text}</div>
                        <div style="font-size: 11px; color: #999;">${time}</div>
                    </div>`;
                });
            }

            modalHtml += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="width: 100%; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; margin-top: 20px; font-weight: 600;">Close</button></div></div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Auto-login if user is remembered
        window.addEventListener('load', async () => {
            const savedUser = localStorage.getItem('currentUser');
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (savedUser) {
                if (savedUser === 'admin-1' && isAdmin) {
                    currentUser = savedUser;
                    loadAdminPanel();
                } else {
                    const userRef = ref(database, `users/${savedUser}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        currentUser = savedUser;
                        loadChatApp();
                    } else {
                        showLogin();
                    }
                }
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>
